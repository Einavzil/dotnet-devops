name: CI/CD Main Branch

on:
  push:
    branches: [ main ]

jobs:
  call-build-test-workflow:
    uses: ./.github/workflows/1-build-test-workflow.yml
  
  call-create-release-worfkflow:
    uses: ./.github/workflows/2-create-release-workflow.yml
    needs: call-build-test-workflow
    secrets: inherit

  call-deploy-testing-ecs-workflow:
    uses: ./.github/workflows/3-deploy-ecs-workflow.yml
    needs: call-create-release-worfkflow
    secrets: inherit
    environment: testing
    inputs:
      image_tag: ${{ needs.call-create-release-worfkflow.outputs.image_tag }}
      task_definition_file: testing-task-definition.json
      cluster_name: testing-cluster
      service_name: testing-service
  
  call-deploy-production-ecs-workflow:
    uses: ./.github/workflows/3-deploy-ecs-workflow.yml
    needs: call-create-release-worfkflow
    secrets: inherit
    environment: production
    inputs:
      image_tag: ${{ needs.call-create-release-worfkflow.outputs.image_tag }}
      task_definition_file: production-task-definition.json
      cluster_name: production-cluster
      service_name: production-service